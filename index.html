<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½•éŸ³åº”ç”¨ - çŠ¶æ€ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .status-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ccc;
            transition: all 0.3s ease;
        }

        .status-indicator.idle {
            background: #999;
        }

        .status-indicator.recording {
            background: #ff4444;
            animation: blink 1s infinite;
        }

        .status-indicator.processing {
            background: #4488ff;
        }

        .status-indicator.uploading {
            background: #ffaa00;
        }

        .status-indicator.success {
            background: #44ff44;
        }

        .status-indicator.error {
            background: #cc0000;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .countdown {
            color: #ff4444;
            font-weight: bold;
        }

        .control-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .record-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .record-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .audio-section {
            margin-bottom: 30px;
            display: none;
        }

        .audio-section.show {
            display: block;
        }

        .audio-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        audio {
            width: 100%;
            border-radius: 10px;
        }

        .log-section {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-section pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-time {
            color: #858585;
        }

        .log-info {
            color: #4ec9b0;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-warning {
            color: #dcdcaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ å½•éŸ³åº”ç”¨</h1>

        <div class="status-section">
            <div class="status-indicator idle" id="statusIndicator"></div>
            <div class="status-text" id="statusText">ç³»ç»Ÿå°±ç»ª</div>
        </div>

        <div class="control-section">
            <button class="record-btn" id="recordBtn">å¼€å§‹å½•éŸ³ (30ç§’)</button>
        </div>

        <div class="audio-section" id="audioSection">
            <h3>æœ¬åœ°æ’­æ”¾ (Blob ç¼“å­˜):</h3>
            <audio id="audioPlayer" controls></audio>
        </div>

        <div class="log-section">
            <pre id="logArea">ç­‰å¾…æ“ä½œ...</pre>
        </div>
    </div>

    <script>
        // çŠ¶æ€æšä¸¾
        const State = {
            IDLE: 'idle',
            RECORDING: 'recording',
            PROCESSING: 'processing',
            UPLOADING: 'uploading',
            SUCCESS: 'success',
            ERROR: 'error'
        };

        // å…¨å±€å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let recordTimer = null;
        let countdownTimer = null;
        let currentState = State.IDLE;
        const RECORD_DURATION = 30; // 30ç§’
        const API_URL = 'http://localhost:8000/upload';

        // DOM å…ƒç´ 
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const recordBtn = document.getElementById('recordBtn');
        const audioSection = document.getElementById('audioSection');
        const audioPlayer = document.getElementById('audioPlayer');
        const logArea = document.getElementById('logArea');

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            const consoleMethod = type === 'error' ? 'error' : type === 'success' ? 'log' : 'log';
            console[consoleMethod](`[${timestamp}] ${message}`);
        }

        // æ›´æ–°çŠ¶æ€
        function updateState(newState, message) {
            currentState = newState;
            statusIndicator.className = `status-indicator ${newState}`;
            statusText.textContent = message;
            addLog(`çŠ¶æ€å˜æ›´: ${message}`, 'info');
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                addLog('å¼€å§‹è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addLog('éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼Œå¼€å§‹é‡‡é›†éŸ³é¢‘æµ', 'success');
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        addLog(`æ”¶åˆ°éŸ³é¢‘æ•°æ®å—ï¼Œå¤§å°: ${event.data.size} bytes`, 'info');
                    }
                };

                mediaRecorder.onstop = () => {
                    addLog('å½•éŸ³åœæ­¢ï¼Œå¼€å§‹å¤„ç†éŸ³é¢‘æ•°æ®...', 'info');
                    processRecording();
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.onerror = (event) => {
                    addLog(`å½•éŸ³é”™è¯¯: ${event.error}`, 'error');
                    updateState(State.ERROR, `é”™è¯¯ - ${event.error}`);
                    recordBtn.disabled = false;
                };

                updateState(State.RECORDING, 'æ­£åœ¨å½•éŸ³ (å€’è®¡æ—¶ 30 ç§’)');
                mediaRecorder.start();
                addLog('MediaRecorder å·²å¯åŠ¨', 'success');

                // å€’è®¡æ—¶
                let remaining = RECORD_DURATION;
                countdownTimer = setInterval(() => {
                    remaining--;
                    if (remaining > 0) {
                        statusText.textContent = `æ­£åœ¨å½•éŸ³ (å€’è®¡æ—¶ ${remaining} ç§’)`;
                    } else {
                        clearInterval(countdownTimer);
                        stopRecording();
                    }
                }, 1000);

                // 30ç§’åè‡ªåŠ¨åœæ­¢
                recordTimer = setTimeout(() => {
                    stopRecording();
                }, RECORD_DURATION * 1000);

                recordBtn.disabled = true;
                recordBtn.textContent = 'å½•éŸ³ä¸­...';

            } catch (error) {
                addLog(`æ•æ‰åˆ°å¼‚å¸¸: ${error.message}`, 'error');
                updateState(State.ERROR, `é”™è¯¯ - ${error.message}`);
                recordBtn.disabled = false;
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                addLog('MediaRecorder å·²åœæ­¢', 'info');
            }
            if (recordTimer) {
                clearTimeout(recordTimer);
                recordTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            recordBtn.textContent = 'å¼€å§‹å½•éŸ³ (30ç§’)';
        }

        // å¤„ç†å½•éŸ³æ•°æ®
        function processRecording() {
            try {
                updateState(State.PROCESSING, 'æœ¬åœ°å·²ç¼“å­˜ (Blob Ready)');
                
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const blobSize = blob.size;
                const blobURL = URL.createObjectURL(blob);
                
                addLog(`Blob ç”ŸæˆæˆåŠŸï¼Œå¤§å°: ${blobSize} bytes (${(blobSize / 1024).toFixed(2)} KB)`, 'success');
                addLog(`æœ¬åœ° URL: ${blobURL}`, 'info');

                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                audioPlayer.src = blobURL;
                audioSection.classList.add('show');
                addLog('éŸ³é¢‘æ’­æ”¾å™¨å·²å‡†å¤‡å°±ç»ª', 'success');

                // ç«‹å³ä¸Šä¼ 
                uploadAudio(blob);

            } catch (error) {
                addLog(`å¤„ç†å½•éŸ³æ•°æ®æ—¶å‡ºé”™: ${error.message}`, 'error');
                updateState(State.ERROR, `é”™è¯¯ - ${error.message}`);
                recordBtn.disabled = false;
            }
        }

        // ä¸Šä¼ éŸ³é¢‘
        async function uploadAudio(blob) {
            try {
                updateState(State.UPLOADING, 'æ­£åœ¨ä¸Šä¼ æœåŠ¡å™¨...');
                addLog('å¼€å§‹å‘åç«¯å‘é€ POST è¯·æ±‚', 'info');

                const formData = new FormData();
                formData.append('file', blob, `recording_${Date.now()}.webm`);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const result = await response.json();
                addLog(`åç«¯å“åº”æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„: ${result.file_path}`, 'success');
                addLog(`ç»å¯¹è·¯å¾„: ${result.absolute_path}`, 'info');
                addLog(`æ–‡ä»¶å¤§å°: ${result.file_size} bytes`, 'info');
                addLog(`ä¸Šä¼ æ—¶é—´: ${result.uploaded_at}`, 'info');

                updateState(State.SUCCESS, 'æœåŠ¡å™¨ä¿å­˜æˆåŠŸ');
                recordBtn.disabled = false;

            } catch (error) {
                addLog(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                updateState(State.ERROR, `é”™è¯¯ - ${error.message}`);
                recordBtn.disabled = false;
            }
        }

        // äº‹ä»¶ç›‘å¬
        recordBtn.addEventListener('click', startRecording);

        // åˆå§‹åŒ–æ—¥å¿—
        addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå°±ç»ª', 'success');
        addLog(`åç«¯ API åœ°å€: ${API_URL}`, 'info');
    </script>
</body>
</html>


